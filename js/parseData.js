let dataJSON = '{"message":"accurate","cod":"200","count":30,"list":[{"id":5392323,"name":"San Luis Obispo","coord":{"lat":35.2827,"lon":-120.6597},"main":{"temp":59.59,"pressure":1017,"humidity":83,"temp_min":58.46,"temp_max":60.98},"dt":1535698680,"wind":{"speed":11.41,"deg":320},"sys":{"country":""},"rain":null,"snow":null,"clouds":{"all":90},"weather":[{"id":804,"main":"Clouds","description":"overcast clouds","icon":"04n"}]},{"id":5372954,"name":"Miles","coord":{"lat":35.1855,"lon":-120.7033},"main":{"temp":59.7,"pressure":1017,"humidity":83,"temp_min":58.46,"temp_max":60.98},"dt":1535698680,"wind":{"speed":11.41,"deg":320},"sys":{"country":""},"rain":null,"snow":null,"clouds":{"all":90},"weather":[{"id":804,"main":"Clouds","description":"overcast clouds","icon":"04n"}]},{"id":5325371,"name":"Avila Beach","coord":{"lat":35.18,"lon":-120.7319},"main":{"temp":59.7,"pressure":1017,"humidity":83,"temp_min":58.46,"temp_max":60.98},"dt":1535698680,"wind":{"speed":11.41,"deg":320},"sys":{"country":""},"rain":null,"snow":null,"clouds":{"all":90},"weather":[{"id":804,"main":"Clouds","description":"overcast clouds","icon":"04n"}]},{"id":5393154,"name":"Santa Margarita","coord":{"lat":35.39,"lon":-120.6091},"main":{"temp":59.99,"pressure":1017,"humidity":83,"temp_min":59,"temp_max":60.98},"dt":1535698560,"wind":{"speed":11.41,"deg":320},"sys":{"country":""},"rain":null,"snow":null,"clouds":{"all":90},"weather":[{"id":804,"main":"Clouds","description":"overcast clouds","icon":"04n"}]},{"id":5392329,"name":"San Luis Obispo County","coord":{"lat":35.3666,"lon":-120.5344},"main":{"temp":59.99,"pressure":1017,"humidity":83,"temp_min":59,"temp_max":60.98},"dt":1535698560,"wind":{"speed":11.41,"deg":320},"sys":{"country":""},"rain":null,"snow":null,"clouds":{"all":90},"weather":[{"id":804,"main":"Clouds","description":"overcast clouds","icon":"04n"}]},{"id":5383431,"name":"Pismo Beach","coord":{"lat":35.1428,"lon":-120.6413},"main":{"temp":59.72,"pressure":1017,"humidity":83,"temp_min":58.46,"temp_max":60.98},"dt":1535698680,"wind":{"speed":11.41,"deg":320},"sys":{"country":""},"rain":null,"snow":null,"clouds":{"all":90},"weather":[{"id":804,"main":"Clouds","description":"overcast clouds","icon":"04n"}]},{"id":5368565,"name":"Los Osos","coord":{"lat":35.3111,"lon":-120.8324},"main":{"temp":59.59,"pressure":1017,"humidity":83,"temp_min":58.46,"temp_max":60.98},"dt":1535698680,"wind":{"speed":11.41,"deg":320},"sys":{"country":""},"rain":null,"snow":null,"clouds":{"all":90},"weather":[{"id":804,"main":"Clouds","description":"overcast clouds","icon":"04n"}]},{"id":5354552,"name":"Grover Beach","coord":{"lat":35.1216,"lon":-120.6213},"main":{"temp":59.72,"pressure":1017,"humidity":83,"temp_min":58.46,"temp_max":60.98},"dt":1535698680,"wind":{"speed":11.41,"deg":320},"sys":{"country":""},"rain":null,"snow":null,"clouds":{"all":90},"weather":[{"id":804,"main":"Clouds","description":"overcast clouds","icon":"04n"}]},{"id":5324802,"name":"Arroyo Grande","coord":{"lat":35.1186,"lon":-120.5908},"main":{"temp":59.72,"pressure":1017,"humidity":83,"temp_min":58.46,"temp_max":60.98},"dt":1535698680,"wind":{"speed":11.41,"deg":320},"sys":{"country":""},"rain":null,"snow":null,"clouds":{"all":90},"weather":[{"id":804,"main":"Clouds","description":"overcast clouds","icon":"04n"}]},{"id":5374920,"name":"Morro Bay","coord":{"lat":35.3658,"lon":-120.8499},"main":{"temp":59.99,"pressure":1017,"humidity":83,"temp_min":59,"temp_max":60.98},"dt":1535698560,"wind":{"speed":11.41,"deg":320},"sys":{"country":""},"rain":null,"snow":null,"clouds":{"all":90},"weather":[{"id":804,"main":"Clouds","description":"overcast clouds","icon":"04n"}]},{"id":5378763,"name":"Oceano","coord":{"lat":35.0989,"lon":-120.6124},"main":{"temp":59.72,"pressure":1017,"humidity":83,"temp_min":58.46,"temp_max":60.98},"dt":1535698680,"wind":{"speed":11.41,"deg":320},"sys":{"country":""},"rain":null,"snow":null,"clouds":{"all":90},"weather":[{"id":804,"main":"Clouds","description":"overcast clouds","icon":"04n"}]},{"id":5325111,"name":"Atascadero","coord":{"lat":35.4894,"lon":-120.6708},"main":{"temp":59.97,"pressure":1017,"humidity":72,"temp_min":59,"temp_max":60.98},"dt":1535698560,"wind":{"speed":12.75,"deg":310},"sys":{"country":""},"rain":null,"snow":null,"clouds":{"all":1},"weather":[{"id":800,"main":"Clear","description":"sky is clear","icon":"01n"}]},{"id":5332963,"name":"Callender","coord":{"lat":35.053,"lon":-120.5963},"main":{"temp":59.29,"pressure":1017,"humidity":83,"temp_min":57.2,"temp_max":60.98},"dt":1535698680,"wind":{"speed":11.41,"deg":320},"sys":{"country":""},"rain":null,"snow":null,"clouds":{"all":90},"weather":[{"id":804,"main":"Clouds","description":"overcast clouds","icon":"04n"}]},{"id":5335131,"name":"Cayucos","coord":{"lat":35.4427,"lon":-120.8922},"main":{"temp":60.53,"pressure":1017,"humidity":83,"temp_min":60.08,"temp_max":60.98},"dt":1535698560,"wind":{"speed":11.41,"deg":320},"sys":{"country":""},"rain":null,"snow":null,"clouds":{"all":90},"weather":[{"id":804,"main":"Clouds","description":"overcast clouds","icon":"04n"}]},{"id":5340687,"name":"Creston","coord":{"lat":35.5189,"lon":-120.5238},"main":{"temp":59.99,"pressure":1017,"humidity":72,"temp_min":59,"temp_max":60.98},"dt":1535698560,"wind":{"speed":12.75,"deg":310},"sys":{"country":""},"rain":null,"snow":null,"clouds":{"all":1},"weather":[{"id":800,"main":"Clear","description":"sky is clear","icon":"01n"}]},{"id":5401516,"name":"Templeton","coord":{"lat":35.5497,"lon":-120.7061},"main":{"temp":60.55,"pressure":1017,"humidity":72,"temp_min":60.08,"temp_max":60.98},"dt":1535698560,"wind":{"speed":12.75,"deg":310},"sys":{"country":""},"rain":null,"snow":null,"clouds":{"all":1},"weather":[{"id":800,"main":"Clear","description":"sky is clear","icon":"01n"}]},{"id":5377100,"name":"Nipomo","coord":{"lat":35.0428,"lon":-120.476},"main":{"temp":59.13,"pressure":1017,"humidity":89,"temp_min":57.2,"temp_max":60.98},"dt":1535698680,"wind":{"speed":6.93,"deg":300},"sys":{"country":""},"rain":null,"snow":null,"clouds":{"all":1},"weather":[{"id":800,"main":"Clear","description":"sky is clear","icon":"01n"}]},{"id":5354591,"name":"Guadalupe","coord":{"lat":34.9716,"lon":-120.5719},"main":{"temp":59.13,"pressure":1017,"humidity":89,"temp_min":57.2,"temp_max":60.98},"dt":1535698680,"wind":{"speed":6.93,"deg":300},"sys":{"country":""},"rain":null,"snow":null,"clouds":{"all":1},"weather":[{"id":800,"main":"Clear","description":"sky is clear","icon":"01n"}]},{"id":5381438,"name":"Paso Robles","coord":{"lat":35.6266,"lon":-120.6911},"main":{"temp":60.57,"pressure":1017,"humidity":72,"temp_min":60.08,"temp_max":60.98},"dt":1535698560,"wind":{"speed":12.75,"deg":310},"sys":{"country":""},"rain":null,"snow":null,"clouds":{"all":1},"weather":[{"id":800,"main":"Clear","description":"sky is clear","icon":"01n"}]},{"id":5393180,"name":"Santa Maria","coord":{"lat":34.953,"lon":-120.4358},"main":{"temp":59.14,"pressure":1017,"humidity":89,"temp_min":57.2,"temp_max":60.98},"dt":1535698680,"wind":{"speed":6.93,"deg":300},"sys":{"country":""},"rain":null,"snow":null,"clouds":{"all":1},"weather":[{"id":800,"main":"Clear","description":"sky is clear","icon":"01n"}]},{"id":5406376,"name":"Village Mobile Home Park","coord":{"lat":34.8883,"lon":-120.4533},"main":{"temp":59.14,"pressure":1017,"humidity":89,"temp_min":57.2,"temp_max":60.98},"dt":1535698680,"wind":{"speed":6.93,"deg":300},"sys":{"country":""},"rain":null,"snow":null,"clouds":{"all":1},"weather":[{"id":800,"main":"Clear","description":"sky is clear","icon":"01n"}]},{"id":5346935,"name":"Estrella","coord":{"lat":35.7055,"lon":-120.6102},"main":{"temp":60.57,"pressure":1017,"humidity":72,"temp_min":60.08,"temp_max":60.98},"dt":1535698560,"wind":{"speed":12.75,"deg":310},"sys":{"country":""},"rain":null,"snow":null,"clouds":{"all":1},"weather":[{"id":800,"main":"Clear","description":"sky is clear","icon":"01n"}]},{"id":5394892,"name":"Shandon","coord":{"lat":35.6553,"lon":-120.3755},"main":{"temp":60.55,"pressure":1017,"humidity":72,"temp_min":60.08,"temp_max":60.98},"dt":1535698560,"wind":{"speed":12.75,"deg":310},"sys":{"country":""},"rain":null,"snow":null,"clouds":{"all":1},"weather":[{"id":800,"main":"Clear","description":"sky is clear","icon":"01n"}]},{"id":5333207,"name":"Cambria","coord":{"lat":35.5641,"lon":-121.0808},"main":{"temp":60.53,"pressure":1017,"humidity":72,"temp_min":60.08,"temp_max":60.98},"dt":1535698560,"wind":{"speed":12.75,"deg":310},"sys":{"country":""},"rain":null,"snow":null,"clouds":{"all":1},"weather":[{"id":800,"main":"Clear","description":"sky is clear","icon":"01n"}]},{"id":5379609,"name":"Orcutt","coord":{"lat":34.8653,"lon":-120.436},"main":{"temp":59.14,"pressure":1017,"humidity":89,"temp_min":57.2,"temp_max":60.98},"dt":1535698680,"wind":{"speed":6.93,"deg":300},"sys":{"country":""},"rain":null,"snow":null,"clouds":{"all":1},"weather":[{"id":800,"main":"Clear","description":"sky is clear","icon":"01n"}]},{"id":5392448,"name":"San Miguel","coord":{"lat":35.7525,"lon":-120.6963},"main":{"temp":60.57,"pressure":1017,"humidity":72,"temp_min":60.08,"temp_max":60.98},"dt":1535698560,"wind":{"speed":12.75,"deg":310},"sys":{"country":""},"rain":null,"snow":null,"clouds":{"all":1},"weather":[{"id":800,"main":"Clear","description":"sky is clear","icon":"01n"}]},{"id":5364615,"name":"Lake Nacimiento","coord":{"lat":35.7283,"lon":-120.8797},"main":{"temp":60.57,"pressure":1017,"humidity":72,"temp_min":60.08,"temp_max":60.98},"dt":1535698560,"wind":{"speed":12.75,"deg":310},"sys":{"country":""},"rain":null,"snow":null,"clouds":{"all":1},"weather":[{"id":800,"main":"Clear","description":"sky is clear","icon":"01n"}]},{"id":7262449,"name":"Vandenberg Air Force Base","coord":{"lat":34.7483,"lon":-120.5182},"main":{"temp":59.14,"pressure":1017,"humidity":93,"temp_min":57.2,"temp_max":60.98},"dt":1535698680,"wind":{"speed":13.87,"deg":350},"sys":{"country":""},"rain":null,"snow":null,"clouds":{"all":1},"weather":[{"id":800,"main":"Clear","description":"sky is clear","icon":"01n"}]},{"id":5405737,"name":"Vandenberg Village","coord":{"lat":34.7083,"lon":-120.4677},"main":{"temp":59.14,"pressure":1017,"humidity":86,"temp_min":57.2,"temp_max":60.98},"dt":1535698680,"wind":{"speed":5.82},"sys":{"country":""},"rain":null,"snow":null,"clouds":{"all":90},"weather":[{"id":804,"main":"Clouds","description":"overcast clouds","icon":"04n"}]},{"id":5368321,"name":"Los Alamos","coord":{"lat":34.7444,"lon":-120.2783},"main":{"temp":59.16,"pressure":1017,"humidity":86,"temp_min":57.2,"temp_max":60.98},"dt":1535698680,"wind":{"speed":5.82},"sys":{"country":""},"rain":null,"snow":null,"clouds":{"all":90},"weather":[{"id":804,"main":"Clouds","description":"overcast clouds","icon":"04n"}]}]}';

let data = JSON.parse(dataJSON);

let sector = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW', 'N'];

let cityWeatherData;
let showMetric = false;

function getCamelCaseName(cityName) {
    return cityName.replace(/(?:^\w|[A-Z]|\b\w)/g, function (letter, index) {
        return index == 0 ? letter.toLowerCase() : letter.toUpperCase();
    }).replace(/\s+/g, '');
}

function buildPullDownMenuAndArm(cityName) {
    let pullDownMenu = document.getElementById("pullDownMenu");
    let newButton = document.createElement("button");
    let idName = getCamelCaseName(cityName) + "Btn";
    let className = "pickCity";
    newButton.id=idName;
    newButton.className=className;
    newButton.innerHTML=cityName;
    pullDownMenu.appendChild(newButton);
    newButton.addEventListener("click", function() {
        let btnCityName = newButton.innerHTML;
        let cityWeatherData=parseData4City(btnCityName, data);
        displayCityData(cityWeatherData);
    });
}

function convert2DateString(timeStamp) {
  let date = new Date(timeStamp*1000);
  let options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric'};
  return date.toLocaleString("en-US");
}

function convert2SI(conversion, value) {
  switch (conversion) {
    case "f2C": return Math.round(((value-32)*5/9)*100)/100;
    case "mPH2MPS" : return Math.round((value*0.44704)*100)/100;
    case "inches2MM" : return Math.round((value*25.4)*100)/100;
    default: return value;
  }
}

function convertDegs2WD(degs) {
  return sector[Math.round((degs%360)/22.5)+1];
}

function parseData4City(cityName, data) {
    return data.list.find((e)=>{return e.name === cityName});
}

function parseDataAllCities(data) {
    for (cityReadings of data.list) {
        displayCityData(cityReadings);
    }
}

function updateBackgroundClassName(cityName) {
    let className;
    let classNameDiv;

    className = getCamelCaseName(cityName);
    classNameDiv = document.getElementById("backgroundId");
    classNameDiv.className = className;

}

function updateCityDiv(cityName) {
    let cityIdName;
    let cityDiv;

    //ADD CITY NAME
    cityIdName = "cityName";
    cityDiv = document.getElementById(cityIdName);
    cityDiv.innerHTML = cityName;   

}

function constructWeatherIcon(weatherInfoArr) {
    let iconId;
    let cityIcon;
    let daynight;

    //CONSTRUCT WEATHER ICON
    iconId = "cityIconTemperature";
    cityIcon = document.getElementById(iconId);
    if (weatherInfoArr.icon.slice(-1) === 'd') {
        daynight = 'day';
    } else {
        daynight = 'night';
    }
    cityIcon.className = "wi wi-owm-" + daynight + "-" + weatherInfoArr.id;
    cityIcon.innerHTML=weatherInfoArr.main;
}

function updateTemperatureDiv(temp) {
    let cityTemperature;
    let cityTemp;

    //ADD TEMPERATURE TO CITY TABLE
    cityTemperature = "cityTemperature"
    cityTemp = document.getElementById(cityTemperature);
    if (!showMetric) {
        cityTemp.innerHTML = temp + " ℉";
    } else {
        cityTemp.innerHTML = convert2SI("f2C", temp) + " °C";
    }
}

function updateHumidityDiv(hum) {
    let humidity;
    let cityHumidity;

    //ADD HUMIDITY TO CITY TABLE
    humidity = "cityHumidity";
    cityHumidity = document.getElementById(humidity);
    cityHumidity.innerHTML = "Humidity: " + hum + "%";
}

function updatePressureDiv(airPres) {
    let pressure;
    let cityPressure;

    //ADD PRESSURE TO CITY TABLE
    pressure = "cityPressure";
    cityPressure = document.getElementById(pressure);
    if (!showMetric) {
        cityPressure.innerHTML = "Pressure: " + airPres + " mbar";
    } else {
        cityPressure.innerHTML = "Pressure: " + airPres + " hPa";
    }
}

function updateMinMaxTempDiv(temp, type) {
    let minMaxtemp;
    let cityMinMaxTemp;

    //ADD TEMP MIN OR MAX TO CITY TABLE
    if (type === "Min") {
        minMaxTemp = "cityTempMin";
    } else {
        minMaxTemp = "cityTempMax"
    }
    cityMinMaxTemp = document.getElementById(minMaxTemp);
    if (!showMetric) {
        cityMinMaxTemp.innerHTML = type + ": " + temp + " ℉";
    } else {
        cityMinMaxTemp.innerHTML = type + ": " + convert2SI("f2C", temp) + " °C";
    }
}

function updateWindDiv(ws) {
    let windSpeed;
    let cityWindSpeed;

    //ADD WIND SPEED TO CITY TABLE
    windSpeed = "cityWindSpeed";
    cityWindSpeed = document.getElementById(windSpeed);
    if (!showMetric) {
        cityWindSpeed.innerHTML = "Wind Speed: " + ws + " mph";
    } else {
        cityWindSpeed.innerHTML = "Wind Speed: " + convert2SI("mPH2MPS", ws) + " m/s";
    }
}

function updateWindDirDiv(deg) {
    let windDirection;
    let cityWindDirection;
    let iconDirection;
    let cityIconWind;
    
    //ADD WIND DIRECTION TO CITY TABLE
    windDirection = "cityWindDirection";
    cityWindDirection = document.getElementById(windDirection);
    iconDirection = "cityIconSpeed";
    cityIconWind = document.getElementById(iconDirection);
    //round to nearest integer
    cityIconWind.className = "wi wi-wind towards-" + Math.round(deg) + "-deg";
    cityWindDirection.innerHTML = "Wind Direction: " + convertDegs2WD(deg);
}

function updateRainSnowDiv(amt, type) {
    let level;
    let cityLevel;

    //ADD RAIN OR SNOW TO CITY TABLE
    if (type === 'Rain') {
        level = "cityRain";
    } else {
        level = "citySnow";
    }
    cityLevel = document.getElementById(level);
    if (amt === null) {
        if (!showMetric) {
            cityLevel.innerHTML = type + ": " + "0.0" + " inches";
        } else {
            cityLevel.innerHTML = type + ": " + "0.0" + " mm";
        }
    } else {
        if (!showMetric) {
            cityRainLevel.innerHTML = type + ": " + amt + " inches";
        } else {
            cityRainLevel.innerHTML = type + ": " + convert2SI("inches2MM", amt) + " mm";
        }
    }
}

function updateDateDiv(dt) {
    let timeStamp;
    let cityTimeStamp;

    timeStamp = "timeStamp";
    cityTimeStamp = document.getElementById(timeStamp);
    cityTimeStamp.innerHTML = convert2DateString(dt);
}

function displayCityData(cityData) {
    //GET BACKGROUND CLASS NAME
    updateBackgroundClassName(cityData.name);

    //ADD CITY NAME
    updateCityDiv(cityData.name);

    //CONSTRUCT WEATHER ICON
    constructWeatherIcon(cityData.weather[0]);

    //ADD TEMPERATURE TO CITY TABLE
    updateTemperatureDiv(cityData.main.temp);

    //ADD HUMIDITY TO CITY TABLE
    updateHumidityDiv(cityData.main.humidity);

    //ADD PRESSURE TO CITY TABLE
    updatePressureDiv(cityData.main.pressure);

    //ADD MIN TEMPERATURE TO CITY TABLE
    updateMinMaxTempDiv(cityData.main.temp_min, "Min");

    //ADD MAX TEMPERATURE TO CITY TABLE
    updateMinMaxTempDiv(cityData.main.temp_max, "Max");

    //ADD WIND SPEED TO CITY TABLE
    updateWindDiv(cityData.wind.speed);

    //ADD WIND DIRECTION TO CITY TABLE
    updateWindDirDiv(cityData.wind.deg);

    //ADD RAIN TO CITY TABLE
    updateRainSnowDiv(cityData.rain, "Rain");

    //ADD SNOW TO CITY TABLE
    updateRainSnowDiv(cityData.snow, "Snow");

    //ADD DATE TO CITY TABLE
    updateDateDiv(cityData.dt);

    //UPDATE FOOTER
    lastUpdated = document.getElementById("LastUpdated");
    let d = new Date();
    let options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric'};
    lastUpdated.innerHTML = "Last updated on: " + d.toLocaleString("en-US");
}

//Sort data by city name
data.list.sort((a,b)=>{
    let cityNameA = a.name.toUpperCase();
    let cityNameB = b.name.toUpperCase();
    return (cityNameA < cityNameB) ? -1 : (cityNameA > cityNameB) ? 1 : 0;
});

//Build Menu and Arm buttons
for (cityWeatherData of data.list) {
    buildPullDownMenuAndArm(cityWeatherData.name);
}

//Build and Arm F/C button.
let myBtn = document.getElementById("fToCButton");
myBtn.addEventListener("click", function() {
    let letter = myBtn.innerHTML;
    let cityNameId = document.getElementById("cityName");
    let cityName = cityNameId.innerHTML;
    if (letter === "F") {
        myBtn.innerHTML = "C";
        showMetric = true;
    } else {
        myBtn.innerHTML = "F";
        showMetric = false;
    }
    //If we haven't selected a city yet. Don't show data.
    if (cityName !== '--') {
        let cityWeatherData=parseData4City(cityName, data);
        displayCityData(cityWeatherData);
    }
});
